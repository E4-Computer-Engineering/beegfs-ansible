---
name: Release

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# yamllint disable-line rule:truthy
on:
  push:
    tags:
      # Match semantic version tags vX.Y.Z where X is 1-2 digits, Y and Z are 1 digit
      - 'v[0-9].[0-9].[0-9]'        # v1.2.3 (X single digit)
      - 'v[0-9][0-9].[0-9].[0-9]'   # v12.3.4 (X double digit)
  # Allow manual trigger
  workflow_dispatch:

jobs:
  validate-and-prepare:
    name: Validate Version and Prepare Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Extract and validate version
        id: extract_version
        run: .github/scripts/extract-version.sh

      - name: Verify CHANGELOG.rst is up to date
        run: |
          # Check if CHANGELOG.rst contains the version being released
          if ! grep -q "^v${{ steps.extract_version.outputs.version }}" CHANGELOG.rst; then
            echo "Error: CHANGELOG.rst does not contain version ${{ steps.extract_version.outputs.version }}"
            echo "Please run 'antsibull-changelog release' locally and commit the changes before creating the tag"
            exit 1
          fi
          echo "CHANGELOG.rst is up to date"

      - name: Upload repository workspace
        uses: actions/upload-artifact@v6
        with:
          name: release-workspace
          path: .
          retention-days: 1

  build-and-publish-collection:
    name: Build and Publish to Ansible Galaxy
    needs: validate-and-prepare
    runs-on: ubuntu-latest
    steps:
      - name: Download release workspace
        uses: actions/download-artifact@v7
        with:
          name: release-workspace
          path: .

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core

      - name: Build collection
        run: |
          ansible-galaxy collection build

      - name: Publish collection to Ansible Galaxy
        run: |
          ansible-galaxy collection publish \
            --token "${{ secrets.GALAXY_TOKEN }}" \
            e4_computer_engineering-beegfs-${{ needs.validate-and-prepare.outputs.version }}.tar.gz

      - name: Upload collection artifact
        uses: actions/upload-artifact@v6
        with:
          name: collection-tarball
          path: e4_computer_engineering-beegfs-${{ needs.validate-and-prepare.outputs.version }}.tar.gz
          retention-days: 90

  create-github-release:
    name: Create GitHub Release
    needs: [validate-and-prepare, build-and-publish-collection]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download release workspace
        uses: actions/download-artifact@v7
        with:
          name: release-workspace
          path: .

      - name: Download collection tarball
        uses: actions/download-artifact@v7
        with:
          name: collection-tarball
          path: .

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ needs.validate-and-prepare.outputs.version }}"
          # Extract the changelog section for this version
          if [ -f "CHANGELOG.rst" ]; then
            # This is a simple extraction - you may need to adjust based on your changelog format
            CHANGELOG=$(sed -n "/^v${VERSION}/,/^v[0-9]/p" CHANGELOG.rst | head -n -1)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changelog=Release version ${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## e4_computer_engineering.beegfs ${{ needs.validate-and-prepare.outputs.version }}

            ${{ steps.changelog.outputs.changelog }}

            ### Installation

            ```bash
            ansible-galaxy collection install e4_computer_engineering.beegfs:${{ needs.validate-and-prepare.outputs.version }}
            ```

            ### Documentation

            - [Collection Documentation](https://e4-computer-engineering.github.io/beegfs-ansible/)
            - [Ansible Galaxy](https://galaxy.ansible.com/ui/repo/published/e4_computer_engineering/beegfs/)

          files: |
            e4_computer_engineering-beegfs-${{ needs.validate-and-prepare.outputs.version }}.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
