# Contributing guide

To contribute please use pull requests.

This collection works only with supported Ansible versions mentioned in [requirements file](requirements.txt).

Automated tests will be run against all PRs, these tests need to pass in order to have them reviewed.

## Tooling

You can use Pyenv to setup a working Python environment with the needed packages.

```text
pyenv install 3.11
pyenv virtualenv 3.11 beegfs-ansible
pyenv activate beegfs-ansible
pip install --upgrade pip
pip install -r requirements.txt
pre-commit install -c .pre-commit-config.yaml
```

After the first time it should pick up the virtual environment automatically by entering the directory and detencting the `.python-version` file.
For Vscode make sure to "Set the Python Interpreter" to the Pyenv virtualenv from the command paletter `CTRL + SHIFT + P`

## Workflow

1. Create a new branch feature branch:

    ```text
    git checkout main
    git pull --rebase
    git checkout -b <myuser>/<mybranch>
    ```

2. Make your changes and create the PR.
3. Wait for the GitHub workflows to complete succesfully.

## Creating a new role

Follow the instructions available in the [Molecule documentation](https://ansible.readthedocs.io/projects/molecule/getting-started/).

NOTE: if adding new roles make sure to write the necessary [Molecule tests](extensions/molecule)

## Handling changes on default branch

If you need to get the latest changes from the `main` branch, you need to rebase and workout the merge conflicts:

```text
git checkout main
git pull --rebase
git checkout <customer_branch>  # OR from the correct worktree path
git rebase main
git push --force
```

WARNING: always use `git pull` with `--rebase` to avoid bad surprises.

## Commits

Guidelines can be found [here](https://www.conventionalcommits.org/).

## Releases

This project uses [antsibull-changelog](https://docs.ansible.com/ansible/latest/dev_guide/developing_collections_changelogs.html#generating-changelogs) to generate changelogs.

As mentioned [here](https://github.com/ansible-community/antsibull-changelog/blob/main/docs/changelogs.md):

* The release version is taken from [galaxy file](galaxy.yml)
* Create a [fragment](changelogs/fragments/) `.yml` file with the `release_summary`:

  ``` yml
  release_summary: |
     | Release Date: 2024-07-05
     | This is the first proper release of the ``e4_computer_engineering.beegfs`` collection
  ```

* If creating new playbooks, create another [fragment](changelogs/fragments/) with the `add` keyword:

  ``` yml
  add object.playbook:
  - name: site.yml
    description: |
      Execute all the playbooks in `playbooks/` directory in the correct order to deploy a Beegfs cluster.
  - name: client.yml
    description: |
      Execute the Beegfs.client role.
  ...
  ```

* If creating a role be sure to include the `argument_specs.yml` file in the `meta` folder like the existing roles

## Documentation

Documentation is generated by the [DocsPush.yml GitHub action](.github/workflows/DocsPush.yml) that makes use of the [GitHub Docs Build project](https://github.com/ansible-community/github-docs-build) from the Ansible community.
Finally, the documentation artifcat is pushed to the `gh-pages` branch that feeds the GitHub Pages.
